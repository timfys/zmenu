@using Menu4Tech.Helper
@using System.Threading
@using Newtonsoft.Json
@inherits UmbracoViewPage
@{
    Layout = "master.cshtml";
    int state = 0;
    var currentLanguage = Thread.CurrentThread.CurrentCulture.TwoLetterISOLanguageName;
    var cssRTL = "";
    
    var request = new UserApiAccessData();

    var apiResponse = new ApiResponse();
    
    try
    {
        request = JsonConvert.DeserializeObject<UserApiAccessData>(Context.Request.Cookies["UserInfo"]);

    }
    catch
    {
        Context.Response.Redirect("/login?t=1");
    }
    
    if (currentLanguage == "he")
    {
        cssRTL = "rtl--label";
    }

}


<style>
    .rtl--label {
        padding-right: 25px;
        text-align: right;
    }
</style>
<link rel="stylesheet" href="/css/Login.css?v=7"/>
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" integrity="sha384-gfdkjb5BdAXd+lj+gudLWI+BXq4IuLW5IT+brZEZsLFm++aCMlF1V92rMkPaX4PP" crossorigin="anonymous">
<section class='login main-ptop'>
    <div class="loading" align="center">
        <img src="~/Content/images/ajax-loader.gif" alt="" style="margin-top:6px;"/>&nbsp;&nbsp;<span>@Umbraco.GetDictionaryValue("Please wait..")</span>
    </div>

    <div class="container white-bg signin py-4 pb-5 py-md-5">
        <p class="h3 h1-md text-center font-weigt-400">@Umbraco.GetDictionaryValue("Step 3")</p>
        <p class="text-center">@Umbraco.GetDictionaryValue("Step 3 Description")</p>
        <div class="progress my-4 mb-md-5">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="66" aria-valuemin="0" aria-valuemax="100" style="width: 66.6%"></div>
        </div>

        <div class="step-content mw-500 mx-auto">
            <form id="frmJoin" name="frmJoin">
                <div id="form-valid">
                    <ul class="ListError">
                    </ul>
                </div>

                <p class="h6 h5-sm text-uppercase text-center font-weight-bold mb-3 text-444">@Umbraco.GetDictionaryValue("Enter company name")</p>
                <p class="h6 h5-sm font-weight-bold mt-3 mt-md-4 pt-3  text-444">@Umbraco.GetDictionaryValue("Company name:")</p>
                <div class="form-group">
                    <div>
                        <div class="input-group input-group-lg">
                            <div class="input-group-prepend">
                                <div class="input-group-text">
                                    <i class="fas fa-building"></i>
                                </div>
                            </div>
                            <input class="form-control" placeholder="" maxlength="36" type="text" id="companyName" name="companyName">
                        </div>
                        <small class="form-text text-muted">@Umbraco.GetDictionaryValue("Please enter your realy company name.")</small>
                    </div>
                </div>
                <p class="h6 h5-sm font-weight-bold mt-3 mt-md-4 pt-3  text-444">@Umbraco.GetDictionaryValue("Company number:")</p>
                <div class="form-group">
                    <div>
                        <div class="input-group input-group-lg">
                            <div class="input-group-prepend">
                                <div class="input-group-text">
                                    <i class="fab fa-draft2digital"></i>
                                </div>
                            </div>
                            <input class="form-control" placeholder="" maxlength="36" type="text" id="companyNumber" name="companyNumber">
                        </div>
                        <small class="form-text text-muted">@Umbraco.GetDictionaryValue("Please enter your realy company number.")</small>
                    </div>
                </div>
                <p class="h6 h5-sm font-weight-bold mt-3 mt-md-4 pt-3  text-444">@Umbraco.GetDictionaryValue("Brand/Branch Name:")</p>
                <div class="form-group">
                    <div>
                        <div class="input-group input-group-lg">
                            <div class="input-group-prepend">
                                <div class="input-group-text">
                                    <i class="far fa-copyright"></i>
                                </div>
                            </div>
                            <input class="form-control" placeholder="" maxlength="36" type="text" id="brand" name="brand">
                        </div>
                        <small class="form-text text-muted">@Umbraco.GetDictionaryValue("Please enter your realy brand name.")</small>
                    </div>
                </div>
                <p class="h6 h5-sm font-weight-bold mt-3 mt-md-4 pt-3  text-444">@Umbraco.GetDictionaryValue("Branch address:")</p>
                <div class="form-group">
                    <div>
                        <div class="input-group input-group-lg">
                            <div class="input-group-prepend">
                                <div class="input-group-text">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                            </div>
                            <input class="form-control" placeholder="" maxlength="36" type="text" id="brandAdress" name="brandAdress">
                        </div>
                        <small class="form-text text-muted">@Umbraco.GetDictionaryValue("Please enter your realy brand adress.")</small>
                    </div>
                </div>
                <p class="h6 h5-sm font-weight-bold mt-3 mt-md-4 pt-3  text-444">@Umbraco.GetDictionaryValue("City")</p>
                <div class="form-group">
                    <div>
                        <div class="input-group input-group-lg">
                            <div class="input-group-prepend">
                                <div class="input-group-text">
                                    <i class="fas fa-city"></i>
                                </div>
                            </div>
                            <input class="form-control" placeholder="" maxlength="36" type="text" id="City" name="City">
                        </div>
                        <small class="form-text text-muted">@Umbraco.GetDictionaryValue("Please enter your realy City")</small>
                    </div>
                </div>
                <div class="text-center w-100 mt-3 mt-md-4">
                    <button class="btn btn-theme-blue btn-lg w-100 w-sm-auto px-sm-5" type="button"  id="register">@Umbraco.GetDictionaryValue("JoinBusinessButtonTitle")</button>
                </div>
            </form>
        </div>
    </div>
</section>
<script src="https://ajax.aspnetcdn.com/ajax/jquery.validate/1.11.1/jquery.validate.min.js"></script>

<script>

    document.querySelector("#companyName").focus();
    
    function setInputFilter(textbox, inputFilter) {
        ["input", "keydown", "keyup", "mousedown", "mouseup", "select", "contextmenu", "drop"].forEach(function (event) {
            textbox.addEventListener(event, function () {
                if (inputFilter(this.value)) {
                    this.oldValue = this.value;
                    this.oldSelectionStart = this.selectionStart;
                    this.oldSelectionEnd = this.selectionEnd;
                } else if (this.hasOwnProperty("oldValue")) {
                    this.value = this.oldValue;
                    this.setSelectionRange(this.oldSelectionStart, this.oldSelectionEnd);
                } else {
                    this.value = "";
                }
            });
        });
    }
    function scrollTP() {
        if ($('html').scrollTop()) {
            $('html').animate({ scrollTop: 0 }, 500);
            return;
        }

        $('body').animate({ scrollTop: 0 }, 500);

        return false;
    }
    async function submitForm()
    {

       let today = new Date();
       let date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();

       date += " " + today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
       
       let companyName = document.querySelector("#companyName");
       let companyNumber = document.querySelector("#companyNumber");
       let brandName = document.querySelector("#brand");
       let brandAddress = document.querySelector("#brandAdress");
       let city = document.querySelector("#City");
       
       if (!ValidateValues([companyName, companyNumber, brandName, brandAddress, city]))
           return;
       
       let data = 
       {
           CompanyName : companyName.value,
           CompanyNumber : companyNumber.value,
           BrandName : brandName.value,
           BrandAddress : brandAddress.value,
           City : city.value,
           ScheduleDateTime : date
       };
       // document.getElementById("frmJoin").submitForm();
       ShowProgress();
       
       setTimeout(async function () {
           
           let resp = await fetch("/JoinBusiness/CreateCompany", 
           {
               method : "POST",
               headers : 
               {
                   "Content-Type" : "application/json",
                   "Language" : "@Html.Raw(Thread.CurrentThread.CurrentCulture.TwoLetterISOLanguageName)",
                   "TimeZoneOffset" : new Date().getTimezoneOffset()
               },
               body : JSON.stringify(data)
           })
           
           let apiResponse = await resp.json();
           
           if (resp.ok)
           {
               await RedirectToCrm(apiResponse)
           }else
           {
               document.getElementById('form-valid').querySelector('ul').insertAdjacentHTML("beforeend", `<li>${apiResponse.resultMessage}</li>`);
               document.getElementById('form-valid').style.display = 'block';
           }
       }, 1000)
       

    }
    async function RedirectToCrm(apiResponse)
    {
        let resp = await fetch("/JoinBusiness/LoginCrm", 
        {
            method : "POST",
            headers : 
            {
                "Content-Type" : "application/json"
            },
            body : JSON.stringify(apiResponse)
        })
        
        if (resp.ok)
        {
            let langIso = document.cookie.split("current_culture=")[1].split(";")[0];
            if(langIso === "")
                langIso = "en"
            let lid = await resp.text();
            window.location.href = `https://crm.menu4u.tech/restaurant/${langIso}/menus?lid=` + lid;
        }else{
            document.getElementById('form-valid').querySelector('ul').insertAdjacentHTML("beforeend", `<li>${apiResponse.resultMessage}</li>`);
            document.getElementById('form-valid').style.display = 'block';
        }
        HideProgress();
    }

    function ValidateValues(domObjectsArray)
        {
            let isValid = true;
            let elemInScroll = false;
            
            for (let i = 0; i < domObjectsArray.length; i++)
            {
                if(domObjectsArray[i].value == '' || domObjectsArray[i].value == 0)
                {
                    domObjectsArray[i].classList.add("customWarning");    
                    if(!elemInScroll){
                        domObjectsArray[i].focus();
                        elemInScroll = true;
                    }
                    isValid = false;
                }else
                {
                    domObjectsArray[i].classList.remove("customWarning");
                }
            }
            
            return isValid;
        }
    function ConvertObjInQueryString(object)
    {
        let objectParams = [];
        let i = 0;
        for (let key in object) {
           objectParams[i] = `${key}=${object[key]}`;
           i++;
        }
        return objectParams.join("&");
    }
    $(document).ready(function () {
        setInputFilter(document.getElementById("companyNumber"), function (value) {
            return /^\d*$/.test(value) && value.length < 20;
        });
        $('#register').on('click', submitForm);
        $('#companyName').focus();
        
    })
       var modal, loading;
    function ShowProgress() {
        modal = document.createElement("DIV");
        modal.className = "modal";
        document.body.appendChild(modal);
        loading = document.getElementsByClassName("loading")[0];
        loading.style.display = "block";
        var top = Math.max(window.innerHeight / 2 - loading.offsetHeight / 2, 0);
        var left = Math.max(window.innerWidth / 2 - loading.offsetWidth / 2, 0);
        loading.style.top = top + "px";
        loading.style.left = left + "px";
        $("#frmJoin :input").prop("disabled", true);
        $("#login").prop("disabled", true);
        $("#register").prop("disabled", true);

    }
    function HideProgress() {
        document.body.removeChild(modal);
        loading.style.display = "none";
        $("#login").prop("disabled", false);
        $("#register").prop("disabled", false);
        $("#frmJoin :input").prop("disabled", false);
    }
</script>