@using Menu4Tech.Helper
@using Menu4Tech.Models
@inherits UmbracoViewPage

@{
    Layout = "/Views/master.cshtml";
    var userSignInData = Cooking.GetCookie<UserSignInData>(Cooking.SignInUserData);
}


<div class="login-form">

    <div style="display: flex; align-items: center; flex-direction: column; gap: 10px">
        <p style="align-self: flex-start" class="main-page-header">@Umbraco.GetDictionaryValue("Sms Verification")</p>
        <div class="login-page-phone-verification-text">
            <p>@Umbraco.GetDictionaryValue("We send SMS to")</p>
            <p>+@(userSignInData.PhonePrefix)@(userSignInData.Mobile)</p>
            <a href="@(TranslationHelper.OverridePathWithCurrentCulture(Url.Action("Login", "JoinBusiness")))" onclick="RedirectToPhoneInput()">@Umbraco.GetDictionaryValue("Change")</a>
        </div>
        <p style="margin-top: 30px;" class="verification-page-text">@Umbraco.GetDictionaryValue("Enter 4-digit code")</p>
        <div class="sms-code">
            <input id="verification-code" autofocus class="code-input" style="height: fit-content !important; color: black;" required="required" type="number" value="@Context.Request.Query["vc"]" tabindex=1>
        </div>
        <p class="error-message" style="display: none"></p>
        <button id="send_again_telegram" style="border: none; background: none; display: flex; align-items: center; gap: 8px; padding: 0; cursor: pointer;">
            <img src="/assets/images/contacts/Telegram.svg" alt="Telegram">
            <span style="color: #0088cc; font-size: 26px;">Verify with Telegram</span>
        </button>
        <button id="seng-again-button" style="border: 0; background: 0; margin-bottom: 0;" class="send-again">
            <img src="/assets/images/send.svg" alt="send">
            <p class="send_text">@Umbraco.GetDictionaryValue("Send Again")</p>
        </button>
        <div class="button button--accent kd-fadeIn" type="button" id="verify">@Umbraco.GetDictionaryValue("Verify")</div>
    </div>
</div>
<div id="telegram_modal" class="modal_telegram">
    <div class="modal_window_background_telegram">
        <div class="modal_window_form_telegram">
            <div class="telegram_modal_header">
                <b class="telegram_modal_header_text">Chat with us</b>
                <button class="close_btn_telegram" onclick="closeTelegramModal()">×</button>
            </div>
            <div class="telegram_modal_body">
                <img class="telegram_qr_code" src="/assets/images/contacts/TelegramQr.svg" alt="QR Code" />
                <p class="telegram_modal_text">Scan the QR code with your phone's camera, then tap the link to start a new chat</p>
                <b class="telegram_modal_text">OR</b>
                <a class="telegram_bot_link_button" href="https://t.me/Smart_Winners_bot" target="_blank">
                    <img class="telegram_modal_icon" src="/assets/images/contacts/Telegram.svg" alt="Telegram" />
                    <p>Open Telegram</p>
                </a>
            </div>
        </div>
    </div>
</div>


@if (!string.IsNullOrEmpty(Context.Request.Query["vc"]) && Context.Request.Query["vc"].First().Length == 4)
{
    <script>
        document.addEventListener("DOMContentLoaded", function (){
            document.querySelector("#verify").click();
        })
    </script>
}

<script>
    function RedirectToPhoneInput(){
        deleteCookie("@Html.Raw(Cooking.SignInUserData)");
        deleteCookie("@Html.Raw(Cooking.LastUsedSignInIso)");
    }
    document.querySelector("#verification-code").oninput = function (e){

        if (`${e.currentTarget.value}`.length >= 4){
            e.currentTarget.value = e.currentTarget.value[0] + e.currentTarget.value[1] + e.currentTarget.value[2] + e.currentTarget.value[3];
        }
        if (`${e.currentTarget.value}`.length === 4){
            document.querySelector("#verify").click();
        }

    }
    
    document.querySelector("#verify").addEventListener("click", async function(){

        let verificationCodeElem = document.querySelector("#verification-code");
        let errorElem = document.querySelector(".error-message");
        
        errorElem.style.color = "red";
        
        if (!verificationCodeElem.value){
            verificationCodeElem.classList.remove("error");
            errorElem.style.display = "block";
            errorElem.textContent = "@Html.Raw(Umbraco.GetDictionaryValue("Please specify the verification code"))"
            return;
        }
        
        verificationCodeElem.classList.remove("error");
        errorElem.style.display = "none";
        
        
        let body = {
            Country: "@Html.Raw(userSignInData.Country)",
            Mobile: "@Html.Raw(userSignInData.Mobile)",
            VerificationCode : verificationCodeElem.value
        }
        
        DisplayLoadingScreen();

        let resp = await fetch("@Html.Raw(Url.Action("TryVerifyPhone", "JoinBusinessApi"))", {
            method: "POST",
            body: JSON.stringify(body),
            headers: {
                "Content-Type": "application/json",
                'X-Fetch-Indicator': 'true'
            }
        })

        let result = await resp.text();

        
        if (resp.ok){
            window.location.href = resp.headers.get("Location");
            errorElem.style.display = "block";
            errorElem.style.color = "green";
            errorElem.textContent = "";
        }else{
            errorElem.style.display = "block";
            errorElem.style.color = "red";
            errorElem.textContent = result;
        }

        CloseLoadingScreen();
    })
    
    document.querySelector("#seng-again-button").addEventListener("click", async function (){

        DisplayLoadingScreen();
        
        let body = {
            Country: "@Html.Raw(userSignInData.Country)",
            Mobile: "@Html.Raw(userSignInData.Mobile)",
        }

        let resp = await fetch("@Html.Raw(Url.Action("SendAgain", "JoinBusinessApi"))", {
            method: "POST",
            body: JSON.stringify(body),
            headers: {
                "Content-Type": "application/json",
                'X-Fetch-Indicator': 'true'
            }
        })

        let result = await resp.text();
        
        let errorElem = document.querySelector(".error-message");

        if (resp.ok){
            errorElem.style.display = "block";
            errorElem.style.color = "green";
            errorElem.textContent = "";
        }else{
            errorElem.style.display = "block";
            errorElem.style.color = "red";
            errorElem.textContent = result;
        }
        
        CloseLoadingScreen();
    })
    document.addEventListener("DOMContentLoaded", function() {
        const telegramButton = document.querySelector("#send_again_telegram");
        const telegramModal = document.querySelector("#telegram_modal");
        const closeButton = document.querySelector(".close_btn_telegram");

        if (telegramButton) {
            telegramButton.addEventListener("click", function(e) {
                e.preventDefault();
                openTelegramModal();
            });
        }

        if (closeButton) {
            closeButton.addEventListener("click", closeTelegramModal);
        }

        function openTelegramModal() {
            telegramModal.style.display = "flex";
        }

        function closeTelegramModal() {
            telegramModal.style.display = "none";
        }

        // Закрытие модального окна при клике вне его
        telegramModal.addEventListener("click", function(e) {
            if (e.target === telegramModal) {
                closeTelegramModal();
            }
        });
    });


</script>
<style>
    .send_again_text_telegram {
        font-size: 26px;
    }
    .modal_telegram {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal_window_background_telegram {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        max-width: 350px;
        width: 100%;
    }

    .telegram_modal_header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .telegram_modal_header_text {
        font-size: 18px;
    }

    .close_btn_telegram {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
    }

    .telegram_qr_code {
        width: 150px;
        height: 150px;
        margin: 0 auto 15px;
        display: block;
    }

    .telegram_modal_text {
        text-align: center;
        margin: 10px 0;
        font-size: 14px;
    }

    .telegram_bot_link_button {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background: #0088cc;
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        text-decoration: none;
        margin-top: 10px;
    }

    .telegram_modal_icon {
        width: 20px;
        height: 20px;
    }

</style>